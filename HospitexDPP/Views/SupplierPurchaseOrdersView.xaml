<UserControl x:Class="HospitexDPP.Views.SupplierPurchaseOrdersView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:HospitexDPP.Controls"
             xmlns:conv="clr-namespace:HospitexDPP.Converters">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <conv:HexToColorConverter x:Key="HexToColor" />
    </UserControl.Resources>

    <Grid>
        <!-- Main content -->
        <DockPanel Margin="24,20">
            <!-- Toolbar -->
            <DockPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Style="{DynamicResource SearchTextBox}"
                         Tag="{DynamicResource Search_PurchaseOrders}"
                         Margin="0,0,12,0" />
                <ItemsControl Style="{DynamicResource FilterToggleBar}"
                              ItemsSource="{Binding StatusFilterOptions}"
                              HorizontalAlignment="Left" />
            </DockPanel>

            <!-- Empty state -->
            <controls:EmptyState Title="{DynamicResource Empty_NoPurchaseOrders}"
                                 Description="{DynamicResource Empty_NoPurchaseOrdersDesc}">
                <controls:EmptyState.Style>
                    <Style TargetType="controls:EmptyState">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasOrders}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </controls:EmptyState.Style>
            </controls:EmptyState>

            <!-- DataGrid -->
            <DataGrid ItemsSource="{Binding PurchaseOrders}"
                      Style="{DynamicResource AdminDataGrid}"
                      Visibility="{Binding HasOrders, Converter={StaticResource BoolToVis}}"
                      MouseDoubleClick="DataGrid_MouseDoubleClick">
                <DataGrid.Columns>
                    <!-- PO Number -->
                    <DataGridTemplateColumn Width="1.2*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_PoNumber}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding PoNumber}" FontWeight="SemiBold"
                                           VerticalAlignment="Center" Margin="12,0"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Brand -->
                    <DataGridTemplateColumn Width="*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Brand}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding BrandName}" VerticalAlignment="Center"
                                           Margin="12,0" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Product -->
                    <DataGridTemplateColumn Width="1.2*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Product}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ProductName}" VerticalAlignment="Center"
                                           Margin="12,0" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Quantity (progress) -->
                    <DataGridTemplateColumn Width="0.8*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Quantity}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ProgressText}" VerticalAlignment="Center"
                                           Margin="12,0" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Status badge -->
                    <DataGridTemplateColumn Width="0.8*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Status}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="4" Padding="8,4" HorizontalAlignment="Left"
                                        Margin="12,0" VerticalAlignment="Center">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding StatusColor, Converter={StaticResource HexToColor}}" Opacity="0.15" />
                                    </Border.Background>
                                    <TextBlock Text="{Binding StatusDisplay}" FontSize="12" FontWeight="Medium">
                                        <TextBlock.Foreground>
                                            <SolidColorBrush Color="{Binding StatusColor, Converter={StaticResource HexToColor}}" />
                                        </TextBlock.Foreground>
                                    </TextBlock>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Batches -->
                    <DataGridTemplateColumn Width="0.6*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Batches}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding BatchCount}" VerticalAlignment="Center"
                                           Margin="12,0" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13"
                                           HorizontalAlignment="Center" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Created -->
                    <DataGridTemplateColumn Width="*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Created}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding CreatedAt}" VerticalAlignment="Center"
                                           Margin="12,0" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Action menu -->
                    <DataGridTemplateColumn Width="Auto">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Style="{DynamicResource ActionMenuButton}"
                                        Click="ActionMenu_Click" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>

        <!-- Drawer overlay -->
        <controls:DrawerPanel IsOpen="{Binding IsDrawerOpen}"
                              CloseCommand="{Binding CloseDrawerCommand}"
                              DrawerWidth="600">
            <controls:DrawerPanel.DrawerContent>
                <DockPanel>
                    <!-- Fixed header -->
                    <TextBlock Text="{Binding SelectedDetail.PoNumber}" Style="{DynamicResource DrawerTitle}"
                               DockPanel.Dock="Top" Margin="24,20,24,0" FontSize="18" FontWeight="Bold" />

                    <!-- Fixed footer -->
                    <StackPanel DockPanel.Dock="Bottom" Margin="24,0,24,20">
                        <Button Content="{DynamicResource Button_Close}"
                                Style="{DynamicResource SecondaryButton}"
                                Command="{Binding CloseDrawerCommand}"
                                HorizontalAlignment="Right" />
                    </StackPanel>

                    <!-- Scrollable content -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Margin="24,16,24,12" Padding="0,0,12,0">
                        <StackPanel>
                            <!-- PO info fields -->
                            <StackPanel Margin="0,0,0,16">
                                <!-- Brand -->
                                <TextBlock Text="{DynamicResource Column_Brand}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <TextBlock Text="{Binding SelectedDetail.BrandName}"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14"
                                           Margin="0,2,0,12" />

                                <!-- Product -->
                                <TextBlock Text="{DynamicResource Column_Product}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <TextBlock Text="{Binding SelectedDetail.ProductName}"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14"
                                           Margin="0,2,0,12" />

                                <!-- Quantity -->
                                <TextBlock Text="{DynamicResource Column_Quantity}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <TextBlock Text="{Binding SelectedDetail.Quantity}"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14"
                                           Margin="0,2,0,12" />

                                <!-- Requested delivery date -->
                                <TextBlock Text="{DynamicResource Label_RequestedDelivery}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <TextBlock Text="{Binding SelectedDetail.RequestedDeliveryDate}"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14"
                                           Margin="0,2,0,12" />

                                <!-- Status -->
                                <TextBlock Text="{DynamicResource Column_Status}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <Border CornerRadius="4" Padding="8,4" HorizontalAlignment="Left"
                                        Margin="0,2,0,12">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding SelectedDetail.StatusColor, Converter={StaticResource HexToColor}}" Opacity="0.15" />
                                    </Border.Background>
                                    <TextBlock Text="{Binding SelectedDetail.StatusDisplay}" FontSize="13" FontWeight="Medium">
                                        <TextBlock.Foreground>
                                            <SolidColorBrush Color="{Binding SelectedDetail.StatusColor, Converter={StaticResource HexToColor}}" />
                                        </TextBlock.Foreground>
                                    </TextBlock>
                                </Border>
                            </StackPanel>

                            <!-- Accept button -->
                            <Button Content="{DynamicResource Button_Accept}"
                                    Style="{DynamicResource PrimaryButton}"
                                    Command="{Binding AcceptCommand}"
                                    HorizontalAlignment="Stretch"
                                    Margin="0,0,0,16">
                                <Button.Visibility>
                                    <Binding Path="SelectedDetail.CanAccept" Converter="{StaticResource BoolToVis}" FallbackValue="Collapsed" />
                                </Button.Visibility>
                            </Button>

                            <!-- Separator -->
                            <Separator Margin="0,0,0,12" />

                            <!-- Order lines section -->
                            <TextBlock Text="{DynamicResource Section_OrderLines}"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       FontSize="14" FontWeight="SemiBold"
                                       Margin="0,0,0,8"
                                       Visibility="{Binding HasLines, Converter={StaticResource BoolToVis}}" />
                            <DataGrid ItemsSource="{Binding SelectedDetail.Lines}"
                                      Style="{DynamicResource InlineDataGrid}"
                                      AutoGenerateColumns="False" IsReadOnly="True"
                                      CanUserAddRows="False" Margin="0,0,0,4"
                                      Visibility="{Binding HasLines, Converter={StaticResource BoolToVis}}">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Binding="{Binding ItemNumber}" Width="1.5*">
                                        <DataGridTextColumn.Header>
                                            <TextBlock Text="{DynamicResource Field_ArticleNumber}" />
                                        </DataGridTextColumn.Header>
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Margin" Value="12,0" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Binding="{Binding Size}" Width="0.5*">
                                        <DataGridTextColumn.Header>
                                            <TextBlock Text="{DynamicResource Field_Size}" />
                                        </DataGridTextColumn.Header>
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Margin" Value="12,0" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Binding="{Binding ColorBrand}" Width="*">
                                        <DataGridTextColumn.Header>
                                            <TextBlock Text="{DynamicResource Field_ColorBrand}" />
                                        </DataGridTextColumn.Header>
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Margin" Value="12,0" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Binding="{Binding Quantity}" Width="0.6*">
                                        <DataGridTextColumn.Header>
                                            <TextBlock Text="{DynamicResource Column_Quantity}" />
                                        </DataGridTextColumn.Header>
                                        <DataGridTextColumn.HeaderStyle>
                                            <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                                                <Setter Property="HorizontalContentAlignment" Value="Right" />
                                            </Style>
                                        </DataGridTextColumn.HeaderStyle>
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="HorizontalAlignment" Value="Right" />
                                                <Setter Property="Margin" Value="0,0,12,0" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>
                            </DataGrid>
                            <!-- Total row -->
                            <TextBlock HorizontalAlignment="Right" Margin="0,0,8,16"
                                       FontSize="13" FontWeight="Bold"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       Visibility="{Binding HasLines, Converter={StaticResource BoolToVis}}">
                                <Run Text="{DynamicResource Label_Total}" /><Run Text=": " /><Run Text="{Binding TotalLineQuantity, Mode=OneWay}" />
                            </TextBlock>

                            <!-- Separator before batches -->
                            <Separator Margin="0,0,0,12"
                                       Visibility="{Binding HasLines, Converter={StaticResource BoolToVis}}" />

                            <!-- Batches section header -->
                            <TextBlock Text="{DynamicResource Label_BatchesInPo}"
                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                       FontSize="14" FontWeight="SemiBold"
                                       Margin="0,0,0,8" />

                            <!-- No batches message -->
                            <TextBlock Text="{DynamicResource Label_NoBatches}"
                                       Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"
                                       Margin="0,0,0,8">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Visible" />
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasBatches}" Value="True">
                                                <Setter Property="Visibility" Value="Collapsed" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>

                            <!-- Batch list -->
                            <ItemsControl ItemsSource="{Binding SelectedDetail.Batches}"
                                          Visibility="{Binding HasBatches, Converter={StaticResource BoolToVis}}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                                                Padding="0,8" Margin="0,0,0,4">
                                            <DockPanel>
                                                <!-- Quantity right-aligned -->
                                                <TextBlock Text="{Binding Quantity, StringFormat='{}{0} st'}"
                                                           DockPanel.Dock="Right"
                                                           Foreground="{DynamicResource TextSecondaryBrush}"
                                                           FontSize="12" VerticalAlignment="Center" />
                                                <!-- Status badge -->
                                                <Border CornerRadius="4" Padding="6,2" DockPanel.Dock="Right"
                                                        Margin="0,0,12,0" VerticalAlignment="Center">
                                                    <Border.Background>
                                                        <SolidColorBrush Color="{Binding StatusColor, Converter={StaticResource HexToColor}}" Opacity="0.15" />
                                                    </Border.Background>
                                                    <TextBlock Text="{Binding StatusDisplay}" FontSize="11" FontWeight="Medium">
                                                        <TextBlock.Foreground>
                                                            <SolidColorBrush Color="{Binding StatusColor, Converter={StaticResource HexToColor}}" />
                                                        </TextBlock.Foreground>
                                                    </TextBlock>
                                                </Border>
                                                <!-- Batch number -->
                                                <TextBlock Text="{Binding BatchNumber}"
                                                           Foreground="{DynamicResource TextPrimaryBrush}"
                                                           FontSize="13" FontWeight="Medium"
                                                           VerticalAlignment="Center" />
                                            </DockPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </controls:DrawerPanel.DrawerContent>
        </controls:DrawerPanel>
    </Grid>
</UserControl>
