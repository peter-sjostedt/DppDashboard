<UserControl x:Class="HospitexDPP.Views.AdminRelationsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:HospitexDPP.Controls"
             xmlns:conv="clr-namespace:HospitexDPP.Converters"
             x:Name="RelationsRoot">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <conv:IsoToCountryConverter x:Key="IsoToCountry" />
    </UserControl.Resources>

    <Grid>
        <!-- Main content -->
        <DockPanel Margin="24,20">
            <!-- Toolbar: search only -->
            <DockPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Style="{DynamicResource SearchTextBox}"
                         Tag="{DynamicResource Search_Relations}"
                         Margin="0,0,12,0" />
                <ItemsControl Style="{DynamicResource FilterToggleBar}"
                              ItemsSource="{Binding StatusFilterOptions}"
                              HorizontalAlignment="Left" />
            </DockPanel>

            <!-- Empty state -->
            <controls:EmptyState Title="{DynamicResource Empty_NoRelations}"
                                 Description="{DynamicResource Empty_NoRelationsDesc}">
                <controls:EmptyState.Style>
                    <Style TargetType="controls:EmptyState">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasRelations}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </controls:EmptyState.Style>
            </controls:EmptyState>

            <!-- Grouped relations list -->
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                          Visibility="{Binding HasRelations, Converter={StaticResource BoolToVis}}">
                <ItemsControl ItemsSource="{Binding GroupedRelations}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                                    CornerRadius="4" Margin="0,0,0,8" Background="{DynamicResource BackgroundBrush}">
                                <Expander IsExpanded="True" BorderThickness="0">
                                    <Expander.Header>
                                        <DockPanel Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=ContentPresenter}}"
                                                   Margin="0,4,8,4">
                                            <!-- Brand action menu -->
                                            <Button DockPanel.Dock="Right"
                                                    Style="{DynamicResource ActionMenuButton}"
                                                    Click="BrandMenu_Click"
                                                    VerticalAlignment="Center" />
                                            <!-- Brand name + count -->
                                            <TextBlock FontWeight="SemiBold" FontSize="14"
                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                       VerticalAlignment="Center" Margin="4,0">
                                                <Run Text="{Binding BrandName, Mode=OneWay}" />
                                                <Run Text=" (" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <Run Text="{Binding Relations.Count, Mode=OneWay}" Foreground="{DynamicResource TextSecondaryBrush}" />
                                                <Run Text=")" Foreground="{DynamicResource TextSecondaryBrush}" />
                                            </TextBlock>
                                        </DockPanel>
                                    </Expander.Header>
                                    <StackPanel>
                                        <!-- Empty state for this brand -->
                                        <TextBlock Text="{DynamicResource Relations_NoSuppliers}"
                                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                                   FontSize="12" FontStyle="Italic"
                                                   Margin="40,8,12,12">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasRelations}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>

                                        <!-- Supplier rows -->
                                        <ItemsControl ItemsSource="{Binding Relations}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border BorderBrush="{DynamicResource BorderLightBrush}"
                                                            BorderThickness="0,1,0,0" Padding="12,8">
                                                        <DockPanel>
                                                            <!-- Action menu -->
                                                            <Button DockPanel.Dock="Right"
                                                                    Style="{DynamicResource ActionMenuButton}"
                                                                    Click="ActionMenu_Click"
                                                                    VerticalAlignment="Center" />

                                                            <!-- Status badge -->
                                                            <controls:StatusBadge IsActive="{Binding IsActive}"
                                                                                  DockPanel.Dock="Right"
                                                                                  VerticalAlignment="Center"
                                                                                  Margin="0,0,16,0" />

                                                            <!-- Supplier name + location -->
                                                            <StackPanel VerticalAlignment="Center" Margin="28,0,12,0">
                                                                <TextBlock Text="{Binding SupplierName}"
                                                                           FontWeight="SemiBold" FontSize="13"
                                                                           Foreground="{DynamicResource TextPrimaryBrush}" />
                                                                <TextBlock Foreground="{DynamicResource TextSecondaryBrush}"
                                                                           FontSize="11"
                                                                           Text="{Binding SupplierLocation}">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Visibility" Value="Visible" />
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding SupplierLocation}" Value="{x:Null}">
                                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding SupplierLocation}" Value="">
                                                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                            </StackPanel>
                                                        </DockPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Expander>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </DockPanel>

        <!-- Drawer overlay -->
        <controls:DrawerPanel IsOpen="{Binding IsDrawerOpen}"
                              CloseCommand="{Binding CancelDrawerCommand}">
            <controls:DrawerPanel.DrawerContent>
                <DockPanel>
                    <!-- Fixed header -->
                    <TextBlock Text="{Binding DrawerTitle}" Style="{DynamicResource DrawerTitle}"
                               DockPanel.Dock="Top" Margin="24,20,24,0" />

                    <!-- Fixed footer -->
                    <StackPanel DockPanel.Dock="Bottom" Margin="24,0,24,20">
                        <TextBlock Text="{Binding StatusMessage}" Foreground="{DynamicResource DangerBrush}"
                                   FontSize="12" Margin="0,0,0,8" TextWrapping="Wrap" />
                        <StackPanel Orientation="Horizontal">
                            <Button Content="{DynamicResource Button_Create}"
                                    Style="{DynamicResource PrimaryButton}"
                                    Command="{Binding SaveCommand}" Margin="0,0,8,0" />
                            <Button Content="{DynamicResource Button_Cancel}"
                                    Style="{DynamicResource SecondaryButton}"
                                    Command="{Binding CancelDrawerCommand}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- Field (label left, field right) -->
                    <Grid Margin="24,12,24,12" VerticalAlignment="Top">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" MinWidth="120" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="{DynamicResource Field_SelectSupplier}"
                                   Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                   VerticalAlignment="Center" Margin="0,0,12,0" />
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding FilteredSupplierOptions}"
                                  SelectedItem="{Binding DrawerSelectedSupplier}"
                                  DisplayMemberPath="SupplierName"
                                  Padding="10,8" FontSize="13" />
                    </Grid>
                </DockPanel>
            </controls:DrawerPanel.DrawerContent>
        </controls:DrawerPanel>
    </Grid>
</UserControl>
