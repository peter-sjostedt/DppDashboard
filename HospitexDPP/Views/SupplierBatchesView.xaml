<UserControl x:Class="HospitexDPP.Views.SupplierBatchesView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="clr-namespace:HospitexDPP.Controls"
             xmlns:conv="clr-namespace:HospitexDPP.Converters">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <conv:HexToColorConverter x:Key="HexToColor" />
        <conv:BoolToChevronConverter x:Key="BoolToChevron" />
    </UserControl.Resources>

    <Grid>
        <!-- Main content -->
        <DockPanel Margin="24,20">
            <!-- Toolbar -->
            <DockPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                <Button Content="{DynamicResource Button_CreateBatch}"
                        Style="{DynamicResource PrimaryButton}"
                        DockPanel.Dock="Right"
                        Command="{Binding AddCommand}" />
                <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                         Style="{DynamicResource SearchTextBox}"
                         Tag="{DynamicResource Search_SupplierBatches}"
                         Margin="0,0,12,0" />
                <ItemsControl Style="{DynamicResource FilterToggleBar}"
                              ItemsSource="{Binding StatusFilterOptions}"
                              HorizontalAlignment="Left" />
            </DockPanel>

            <!-- Empty state -->
            <controls:EmptyState Title="{DynamicResource Empty_NoSupplierBatches}"
                                 Description="{DynamicResource Empty_NoSupplierBatchesDesc}"
                                 ActionText="{DynamicResource Button_CreateBatch}"
                                 ActionCommand="{Binding AddCommand}">
                <controls:EmptyState.Style>
                    <Style TargetType="controls:EmptyState">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding HasBatches}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </controls:EmptyState.Style>
            </controls:EmptyState>

            <!-- DataGrid -->
            <DataGrid ItemsSource="{Binding Batches}"
                      Style="{DynamicResource AdminDataGrid}"
                      Visibility="{Binding HasBatches, Converter={StaticResource BoolToVis}}"
                      MouseDoubleClick="DataGrid_MouseDoubleClick">
                <DataGrid.Columns>
                    <!-- Batch Number -->
                    <DataGridTemplateColumn Width="1*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_BatchNumber}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding BatchNumber}" FontWeight="SemiBold"
                                           VerticalAlignment="Center" Margin="12,0"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- PO Number -->
                    <DataGridTemplateColumn Width="1*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_PoNumber}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding PoNumber}" VerticalAlignment="Center"
                                           Margin="12,0" Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Product -->
                    <DataGridTemplateColumn Width="1.2*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Product}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ProductName}" VerticalAlignment="Center"
                                           Margin="12,0" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Quantity -->
                    <DataGridTemplateColumn Width="0.6*">
                        <DataGridTemplateColumn.HeaderStyle>
                            <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                                <Setter Property="HorizontalContentAlignment" Value="Right" />
                            </Style>
                        </DataGridTemplateColumn.HeaderStyle>
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Quantity}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding QuantityDisplay}" VerticalAlignment="Center"
                                           HorizontalAlignment="Right" Margin="0,0,12,0"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Items -->
                    <DataGridTemplateColumn Width="0.5*">
                        <DataGridTemplateColumn.HeaderStyle>
                            <Style TargetType="DataGridColumnHeader" BasedOn="{StaticResource {x:Type DataGridColumnHeader}}">
                                <Setter Property="HorizontalContentAlignment" Value="Right" />
                            </Style>
                        </DataGridTemplateColumn.HeaderStyle>
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Items}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ItemCount}" VerticalAlignment="Center"
                                           HorizontalAlignment="Right" Margin="0,0,12,0"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Status badge -->
                    <DataGridTemplateColumn Width="0.8*">
                        <DataGridTemplateColumn.Header>
                            <TextBlock Text="{DynamicResource Column_Status}" />
                        </DataGridTemplateColumn.Header>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Border CornerRadius="4" Padding="8,4" HorizontalAlignment="Left"
                                        Margin="12,0" VerticalAlignment="Center">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding StatusColor, Converter={StaticResource HexToColor}}" Opacity="0.15" />
                                    </Border.Background>
                                    <TextBlock Text="{Binding StatusDisplay}" FontSize="12" FontWeight="Medium">
                                        <TextBlock.Foreground>
                                            <SolidColorBrush Color="{Binding StatusColor, Converter={StaticResource HexToColor}}" />
                                        </TextBlock.Foreground>
                                    </TextBlock>
                                </Border>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>

                    <!-- Action menu -->
                    <DataGridTemplateColumn Width="Auto">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Style="{DynamicResource ActionMenuButton}"
                                        Click="ActionMenu_Click" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>

        <!-- Drawer overlay -->
        <controls:DrawerPanel IsOpen="{Binding IsDrawerOpen}"
                              CloseCommand="{Binding CancelDrawerCommand}"
                              DrawerWidth="600">
            <controls:DrawerPanel.DrawerContent>
                <DockPanel>
                    <!-- Fixed header -->
                    <TextBlock Text="{Binding DrawerTitle}" Style="{DynamicResource DrawerTitle}"
                               DockPanel.Dock="Top" Margin="24,20,24,0" />

                    <!-- Split info banner -->
                    <Border DockPanel.Dock="Top" Background="#E3F2FD" CornerRadius="6"
                            Padding="12,10" Margin="24,12,24,0"
                            Visibility="{Binding IsSplitMode, Converter={StaticResource BoolToVis}}">
                        <TextBlock Text="{DynamicResource Action_SplitBatchDesc}"
                                   Foreground="#1565C0" FontSize="12" TextWrapping="Wrap" />
                    </Border>

                    <!-- Fixed footer -->
                    <StackPanel DockPanel.Dock="Bottom" Margin="24,0,24,20">
                        <TextBlock Text="{Binding StatusMessage}" Foreground="{DynamicResource DangerBrush}"
                                   FontSize="12" Margin="0,0,0,8" TextWrapping="Wrap" />
                        <StackPanel Orientation="Horizontal">
                            <Button Content="{DynamicResource Button_Save}"
                                    Style="{DynamicResource PrimaryButton}"
                                    Command="{Binding SaveCommand}" Margin="0,0,8,0" />
                            <Button Content="{DynamicResource Button_Cancel}"
                                    Style="{DynamicResource SecondaryButton}"
                                    Command="{Binding CancelDrawerCommand}" />
                        </StackPanel>
                    </StackPanel>

                    <!-- Scrollable content -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Margin="24,12,24,12" Padding="0,0,12,0">
                        <StackPanel>

                            <!-- ======================== -->
                            <!-- CREATE MODE: PO dropdown -->
                            <!-- ======================== -->
                            <StackPanel Visibility="{Binding IsCreateMode, Converter={StaticResource BoolToVis}}"
                                        Margin="0,0,0,16">
                                <TextBlock Text="{DynamicResource Label_SelectPo}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" Margin="0,0,0,4" />
                                <ComboBox ItemsSource="{Binding AvailablePurchaseOrders}"
                                          SelectedItem="{Binding SelectedPo}"
                                          DisplayMemberPath="PoNumber"
                                          Padding="10,8" FontSize="13" />

                                <!-- Selected PO info -->
                                <StackPanel Margin="0,8,0,0">
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding SelectedPo}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>
                                    <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12">
                                        <Run Text="{DynamicResource Column_Brand}" /><Run Text=": " /><Run Text="{Binding SelectedPo.BrandName, Mode=OneWay}" />
                                    </TextBlock>
                                    <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12">
                                        <Run Text="{DynamicResource Column_Product}" /><Run Text=": " /><Run Text="{Binding SelectedPo.ProductName, Mode=OneWay}" />
                                    </TextBlock>
                                    <TextBlock Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12">
                                        <Run Text="{DynamicResource Column_Quantity}" /><Run Text=": " /><Run Text="{Binding SelectedPo.Quantity, Mode=OneWay}" />
                                    </TextBlock>
                                </StackPanel>
                            </StackPanel>

                            <!-- ======================== -->
                            <!-- EDIT MODE: Read-only info -->
                            <!-- ======================== -->
                            <StackPanel Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVis}}"
                                        Margin="0,0,0,12">
                                <TextBlock Text="{DynamicResource Column_PoNumber}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <TextBlock Text="{Binding SelectedBatchDetail.PoNumber}"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14" Margin="0,2,0,8" />

                                <TextBlock Text="{DynamicResource Column_Brand}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <TextBlock Text="{Binding SelectedBatchDetail.BrandName}"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14" Margin="0,2,0,8" />

                                <TextBlock Text="{DynamicResource Column_Product}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <TextBlock Text="{Binding SelectedBatchDetail.ProductName}"
                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="14" Margin="0,2,0,8" />

                                <!-- Status badge -->
                                <TextBlock Text="{DynamicResource Column_Status}"
                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12" />
                                <Border CornerRadius="4" Padding="8,4" HorizontalAlignment="Left" Margin="0,2,0,8">
                                    <Border.Background>
                                        <SolidColorBrush Color="{Binding SelectedBatchDetail.StatusColor, Converter={StaticResource HexToColor}}" Opacity="0.15" />
                                    </Border.Background>
                                    <TextBlock Text="{Binding SelectedBatchDetail.StatusDisplay}" FontSize="13" FontWeight="Medium">
                                        <TextBlock.Foreground>
                                            <SolidColorBrush Color="{Binding SelectedBatchDetail.StatusColor, Converter={StaticResource HexToColor}}" />
                                        </TextBlock.Foreground>
                                    </TextBlock>
                                </Border>
                            </StackPanel>

                            <!-- ======================== -->
                            <!-- SECTION: Batch Info      -->
                            <!-- ======================== -->
                            <Expander IsExpanded="True" Style="{DynamicResource SectionExpander}">
                                <Expander.Header>
                                    <TextBlock Text="{DynamicResource Label_BatchInfo}"
                                               Style="{DynamicResource SectionHeader}" />
                                </Expander.Header>
                                <Grid Margin="0,8,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="140" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="{DynamicResource Field_BatchNumber}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="0" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditBatchNumber, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="{DynamicResource Field_ProductionDate}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="1" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditProductionDate, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="{DynamicResource Field_Quantity}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="2" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditQuantity, UpdateSourceTrigger=PropertyChanged}" />
                                </Grid>
                            </Expander>

                            <!-- ======================== -->
                            <!-- SECTION: Facility Info   -->
                            <!-- ======================== -->
                            <Expander IsExpanded="True" Style="{DynamicResource SectionExpander}" Margin="0,8,0,0">
                                <Expander.Header>
                                    <TextBlock Text="{DynamicResource Label_FacilityInfo}"
                                               Style="{DynamicResource SectionHeader}" />
                                </Expander.Header>
                                <Grid Margin="0,8,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" MinWidth="140" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="{DynamicResource Label_FacilityName}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="0" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditFacilityName, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="1" Grid.Column="0" Text="{DynamicResource Label_FacilityLocation}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="1" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditFacilityLocation, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="2" Grid.Column="0" Text="{DynamicResource Field_FacilityRegistry}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="2" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditFacilityRegistry, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="3" Grid.Column="0" Text="{DynamicResource Field_FacilityIdentifier}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="3" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditFacilityIdentifier, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="4" Grid.Column="0" Text="{DynamicResource Label_CountryConfection}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="4" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditCountryConfection, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="5" Grid.Column="0" Text="{DynamicResource Label_CountryDyeing}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="5" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditCountryDyeing, UpdateSourceTrigger=PropertyChanged}" />

                                    <TextBlock Grid.Row="6" Grid.Column="0" Text="{DynamicResource Label_CountryWeaving}"
                                               Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                               VerticalAlignment="Center" Margin="0,0,12,8" />
                                    <TextBox Grid.Row="6" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                             Text="{Binding EditCountryWeaving, UpdateSourceTrigger=PropertyChanged}" />
                                </Grid>
                            </Expander>

                            <!-- =============================== -->
                            <!-- SECTION: Linked materials       -->
                            <!-- (edit mode only)                -->
                            <!-- =============================== -->
                            <Expander IsExpanded="True" Style="{DynamicResource SectionExpander}" Margin="0,8,0,0"
                                      Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVis}}">
                                <Expander.Header>
                                    <TextBlock Text="{DynamicResource Label_BatchMaterials}"
                                               Style="{DynamicResource SectionHeader}" />
                                </Expander.Header>
                                <StackPanel Margin="0,8,0,0">
                                    <!-- No materials message -->
                                    <TextBlock Text="{DynamicResource Empty_NoSupplierMaterials}"
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"
                                               Margin="0,0,0,8">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Visible" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasMaterials}" Value="True">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <!-- Materials list -->
                                    <ItemsControl ItemsSource="{Binding BatchMaterials}"
                                                  Visibility="{Binding HasMaterials, Converter={StaticResource BoolToVis}}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1"
                                                        Padding="0,6" Margin="0,0,0,2">
                                                    <DockPanel>
                                                        <Button Content="✕" FontSize="11" Padding="4,2"
                                                                DockPanel.Dock="Right"
                                                                Command="{Binding DataContext.RemoveMaterialCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                                CommandParameter="{Binding}"
                                                                Style="{DynamicResource DangerButtonSmall}" />
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding MaterialName}"
                                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                                       FontSize="13" FontWeight="Medium" />
                                                            <TextBlock Text="{Binding Component}"
                                                                       Foreground="{DynamicResource TextSecondaryBrush}"
                                                                       FontSize="11" />
                                                        </StackPanel>
                                                    </DockPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Add material dropdown + button -->
                                    <DockPanel Margin="0,8,0,0">
                                        <Button Content="{DynamicResource Label_AddMaterial}"
                                                Style="{DynamicResource SecondaryButton}"
                                                DockPanel.Dock="Right"
                                                Command="{Binding AddMaterialCommand}"
                                                Margin="8,0,0,0" />
                                        <ComboBox ItemsSource="{Binding AvailableMaterials}"
                                                  SelectedItem="{Binding SelectedMaterial}"
                                                  DisplayMemberPath="MaterialName"
                                                  Padding="10,8" FontSize="13" />
                                    </DockPanel>
                                </StackPanel>
                            </Expander>

                            <!-- =============================== -->
                            <!-- SECTION: Registered items       -->
                            <!-- (edit mode only)                -->
                            <!-- =============================== -->
                            <Expander IsExpanded="True" Style="{DynamicResource SectionExpander}" Margin="0,8,0,0"
                                      Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVis}}">
                                <Expander.Header>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{DynamicResource Label_Items}"
                                                   Style="{DynamicResource SectionHeader}" />
                                        <TextBlock Text=" (" Foreground="{DynamicResource TextSecondaryBrush}"
                                                   FontSize="14" VerticalAlignment="Center" />
                                        <TextBlock Text="{Binding ItemCountLabel}" Foreground="{DynamicResource TextSecondaryBrush}"
                                                   FontSize="14" VerticalAlignment="Center" />
                                        <TextBlock Text=")" Foreground="{DynamicResource TextSecondaryBrush}"
                                                   FontSize="14" VerticalAlignment="Center" />
                                    </StackPanel>
                                </Expander.Header>
                                <StackPanel Margin="0,8,0,0">
                                    <!-- No items message -->
                                    <TextBlock Text="{DynamicResource Empty_NoSupplierItems}"
                                               Foreground="{DynamicResource TextSecondaryBrush}" FontSize="12"
                                               Margin="0,0,0,8">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Visible" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasItems}" Value="True">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>

                                    <!-- Grouped items by variant -->
                                    <ItemsControl ItemsSource="{Binding ItemGroups}"
                                                  Visibility="{Binding HasItems, Converter={StaticResource BoolToVis}}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Margin="0,0,0,2">
                                                    <!-- Summary row — clickable -->
                                                    <Button Command="{Binding DataContext.ToggleGroupCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding}"
                                                            Style="{DynamicResource TransparentButton}"
                                                            HorizontalContentAlignment="Stretch">
                                                        <Grid>
                                                            <Grid.ColumnDefinitions>
                                                                <ColumnDefinition Width="20" />
                                                                <ColumnDefinition Width="*" />
                                                                <ColumnDefinition Width="Auto" />
                                                            </Grid.ColumnDefinitions>

                                                            <TextBlock Grid.Column="0"
                                                                       Text="{Binding IsExpanded, Converter={StaticResource BoolToChevron}}"
                                                                       FontSize="10" VerticalAlignment="Center"
                                                                       Foreground="{DynamicResource TextSecondaryBrush}" />

                                                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                                                                <TextBlock Text="{Binding Size}" FontWeight="SemiBold"
                                                                           Foreground="{DynamicResource TextPrimaryBrush}" FontSize="13" />
                                                                <TextBlock Text=" · " Foreground="{DynamicResource TextSecondaryBrush}" FontSize="13" />
                                                                <TextBlock Text="{Binding ColorBrand}"
                                                                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="13" />
                                                            </StackPanel>

                                                            <TextBlock Grid.Column="2" Text="{Binding Count}"
                                                                       FontWeight="SemiBold" FontSize="13"
                                                                       Foreground="{DynamicResource TextPrimaryBrush}"
                                                                       VerticalAlignment="Center" />
                                                        </Grid>
                                                    </Button>

                                                    <!-- Expanded serial numbers -->
                                                    <Border Visibility="{Binding IsExpanded, Converter={StaticResource BoolToVis}}"
                                                            Background="{DynamicResource BackgroundBrush}"
                                                            CornerRadius="4" Padding="12,8" Margin="20,4,0,4"
                                                            BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                                        <ItemsControl ItemsSource="{Binding SerialNumbers}">
                                                            <ItemsControl.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <WrapPanel />
                                                                </ItemsPanelTemplate>
                                                            </ItemsControl.ItemsPanel>
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <TextBlock Text="{Binding}" FontSize="11"
                                                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                                                               Margin="0,0,12,2" FontFamily="Consolas" />
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>
                                                    </Border>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Bulk-create section -->
                                    <Separator Margin="0,12,0,12" />
                                    <TextBlock Text="{DynamicResource Button_BulkCreate}"
                                               Foreground="{DynamicResource TextPrimaryBrush}"
                                               FontSize="13" FontWeight="SemiBold" Margin="0,0,0,8" />

                                    <Grid Margin="0,0,0,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" MinWidth="120" />
                                            <ColumnDefinition Width="*" />
                                        </Grid.ColumnDefinitions>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>

                                        <TextBlock Grid.Row="0" Grid.Column="0" Text="{DynamicResource Label_SelectVariant}"
                                                   Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                                   VerticalAlignment="Center" Margin="0,0,12,8" />
                                        <ComboBox Grid.Row="0" Grid.Column="1" Margin="0,0,0,8"
                                                  ItemsSource="{Binding AvailableVariants}"
                                                  SelectedItem="{Binding SelectedVariant}"
                                                  Padding="10,8" FontSize="13">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock>
                                                        <Run Text="{Binding ItemNumber, Mode=OneWay}" />
                                                        <Run Text=" – " />
                                                        <Run Text="{Binding Size, Mode=OneWay}" />
                                                        <Run Text=" " />
                                                        <Run Text="{Binding ColorBrand, Mode=OneWay}" />
                                                    </TextBlock>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>

                                        <TextBlock Grid.Row="1" Grid.Column="0" Text="{DynamicResource Label_BulkQuantity}"
                                                   Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                                   VerticalAlignment="Center" Margin="0,0,12,8" />
                                        <TextBox Grid.Row="1" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                                 Text="{Binding BulkQuantity, UpdateSourceTrigger=PropertyChanged}" />

                                        <TextBlock Grid.Row="2" Grid.Column="0" Text="{DynamicResource Label_SerialPrefix}"
                                                   Style="{DynamicResource FormLabel}" TextAlignment="Right"
                                                   VerticalAlignment="Center" Margin="0,0,12,8" />
                                        <TextBox Grid.Row="2" Grid.Column="1" Style="{DynamicResource FormTextBox}" Margin="0,0,0,8"
                                                 Text="{Binding BulkSerialPrefix, UpdateSourceTrigger=PropertyChanged}" />
                                    </Grid>

                                    <Button Content="{DynamicResource Button_BulkCreate}"
                                            Style="{DynamicResource PrimaryButton}"
                                            Command="{Binding BulkCreateItemsCommand}"
                                            HorizontalAlignment="Left" />
                                </StackPanel>
                            </Expander>

                        </StackPanel>
                    </ScrollViewer>
                </DockPanel>
            </controls:DrawerPanel.DrawerContent>
        </controls:DrawerPanel>
    </Grid>
</UserControl>
